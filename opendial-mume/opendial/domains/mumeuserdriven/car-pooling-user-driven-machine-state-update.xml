<?xml version="1.0" encoding="UTF-8"?>
<domain id="MachineState">
    <model id="InformationRetrieval" trigger="NewInformation">
        <rule id="StartSlot">
            <case>
                <!--The user communicate both the start slot and the start city -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_SLOT"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Slot({X})"/>
                    <if var="NewInformation" relation="contains" value="City({Y})"/>
                    <if var="NewInformation" relation="contains" value="Lat({LAT})"/>
                    <if var="NewInformation" relation="contains" value="Lon({LON})"/>
                </condition>
                <effect>
                    <set var="StartSlot" value="{X}"/>
                    <set var="StartCity" value="{Y}"/>
                    <set var="StartLat" value="{LAT}"/>
                    <set var="StartLon" value="{LON}"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_TIME"/>
                </effect>
            </case>
            <case>
                <!--The user communicate the start slot and the system inferred its city -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_SLOT"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <!--The code has to check if the comunicated city corresponds to the inferred city -->
                    <if var="NewInformation" relation="contains" value="Slot({X})"/>
                    <if var="NewInformation" relation="contains" value="InferredCity({Y})"/>
                    <if var="NewInformation" relation="contains" value="Lat({LAT})"/>
                    <if var="NewInformation" relation="contains" value="Lon({LON})"/>
                </condition>
                <effect>
                    <set var="StartSlot" value="{X}"/>
                    <set var="StartCity" value="{Y}"/>
                    <set var="StartLat" value="{LAT}"/>
                    <set var="StartLon" value="{LON}"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_CITY_CONFIRM"/>
                </effect>
            </case>
            <case>
                <!-- The user didn't communicate any start location's information -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_SLOT"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Slot(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_SLOT"/>
                </effect>
            </case>

            <case>
                <!--The user confirms the inferred city -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_CITY_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                </condition>
                <effect>
                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_TIME"/>
                </effect>
            </case>
            <case>
                <!--The system rejects the inferred city -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_CITY_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <set var="StartSlot" value="Missing"/>
                    <set var="StartCity" value="Missing"/>
                    <set var="StartLat" value="Missing"/>
                    <set var="StartLon" value="Missing"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_SLOT"/>
                </effect>
            </case>
            <case>
                <!--The user didn't respond significantly to the city confirmation question -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_START_CITY_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_CITY_CONFIRM"/>
                </effect>
            </case>
        </rule>

        <rule id="StartTime">
            <case>
                <!--The user communicate a start time -->
                <!--The system has to check if the itime is a suitable one -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_START_TIME,ASK_START_TIME_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Time({T})"/>
                    <if var="NewInformation" relation="contains" value="Date({D})"/>
                </condition>
                <effect>
                    <set var="StartDate" value="{D}"/>
                    <set var="StartTime" value="{T}"/>

                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_SLOT"/>
                </effect>
            </case>
            <case>
                <!--If the user didn't comunicate a start time, keep asking -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_START_TIME,ASK_START_TIME_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Time(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_TIME_MORE"/>
                </effect>
            </case>
        </rule>

        <rule id="EndSlot">
            <case>
                <!--Jurney type: A->A -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_SLOT"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <!-- Question: "Vuoi tornare dove sei partito?" -->
                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                </condition>
                <effect>
                    <set var="EndSlot" value="{StartSlot}"/>
                    <set var="EndCity" value="{StartCity}"/>
                    <set var="EndLat" value="{StartLat}"/>
                    <set var="EndLon" value="{StartLon}"/>

                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME"/>
                </effect>
            </case>
            <case>
                <!--Journey type: A->B -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_END_SLOT,ASK_END_SLOT_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Slot({X})"/>
                    <if var="NewInformation" relation="contains" value="City({Y})"/>
                    <if var="NewInformation" relation="contains" value="Lat({LAT})"/>
                    <if var="NewInformation" relation="contains" value="Lon({LON})"/>
                </condition>
                <effect>
                    <set var="EndSlot" value="{X}"/>
                    <set var="EndCity" value="{Y}"/>
                    <set var="EndLat" value="{LAT}"/>
                    <set var="EndLon" value="{LON}"/>

                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME"/>
                </effect>
            </case>
            <case>
                <!--Journey type: A->B -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_END_SLOT,ASK_END_SLOT_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Slot({X})"/>
                    <if var="NewInformation" relation="contains" value="InferredCity({Y})"/>
                    <if var="NewInformation" relation="contains" value="Lat({LAT})"/>
                    <if var="NewInformation" relation="contains" value="Lon({LON})"/>
                </condition>
                <effect>
                    <set var="EndSlot" value="{X}"/>
                    <set var="EndCity" value="{Y}"/>
                    <set var="EndLat" value="{LAT}"/>
                    <set var="EndLon" value="{LON}"/>

                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME"/>
                </effect>
            </case>
            <case>
                <!--The user didn't communicate the end slot B -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_SLOT"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                    <if var="NewInformation" relation="!contains" value="Slot(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_SLOT_MORE"/>
                </effect>
            </case>
            <case>
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_SLOT_MORE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Answer(false)"/>
                    <if var="NewInformation" relation="!contains" value="Slot(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_SLOT"/>
                </effect>
            </case>
        </rule>

        <rule id="EndTime">
            <case>
                <!--The user doesn't know the end time -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_TIME"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <!-- Qustion: "Sai a che ora poserai l'auto?" -->
                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <set var="EndTimeKnown" value="false"/>

                    <!-- Go on -->
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_VEHICLE_TYPE"/>
                </effect>
            </case>
            <case>
                <!--The user communicated the end time -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_END_TIME,ASK_END_TIME_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Time({T})"/>
                    <if var="NewInformation" relation="contains" value="Date({D})"/>
                </condition>
                <effect>
                    <set var="EndTimeKnown" value="true"/>
                    <set var="EndTime" value="{T}"/>
                    <set var="EndDate" value="{D}"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_VEHICLE_TYPE"/>
                </effect>
            </case>
            <case>
                <!--The user keeps telling nonsense instead of the start time -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_TIME"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Time(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME_MORE"/>
                </effect>
            </case>
            <case>
                <!--The user keeps telling nonsense instead of the start time -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_TIME_MORE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Time(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME_MORE"/>
                </effect>
            </case>
            <case>
                <!--The user didn't respond in any meaningful way -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_END_TIME"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Answer(false)"/>
                    <if var="NewInformation" relation="!contains" value="Time(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_END_TIME"/>
                </effect>
            </case>
        </rule>

        <rule id="VehicleType">
            <case>
                <!-- The user is fine with using a base economic car model -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_VEHICLE_TYPE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <!-- Question: "Va bene un'auto economica?" -->
                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                </condition>
                <effect>
                    <set var="VehicleType" value="economy"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_STOPS"/>
                </effect>
            </case>
            <case>
                <!-- The user communicated a vehicle type -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_VEHICLE_TYPE,ASK_VEHICLE_TYPE_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="VehicleType({VT})"/>
                </condition>
                <effect>
                    <set var="VehicleType" value="{VT}"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_STOPS"/>
                </effect>
            </case>
            <case>
                <!-- The user said he want another type of vehicle but didn't say what kind -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_VEHICLE_TYPE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                    <if var="NewInformation" relation="!contains" value="VehicleType(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_VEHICLE_TYPE_MORE"/>
                </effect>
            </case>
            <case>
                <!-- The user said he want another type of vehicle but didn't say what kind -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_VEHICLE_TYPE_MORE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="VehicleType(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_VEHICLE_TYPE_MORE"/>
                </effect>
            </case>
            <case>
                <!-- The user didn't say anyhting useful -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_VEHICLE_TYPE"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(*)"/>
                    <if var="NewInformation" relation="!contains" value="VehicleType(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_VEHICLE_TYPE"/>
                </effect>
            </case>
        </rule>

        <rule id="Stops">
            <case>
                <!-- The user does not want to tell any intermidiate stop -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_STOPS"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <!-- Question: "Vuoi indicare delle fermate intermedie?" -->
                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <set var="StopsKnown" value="false"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="FINAL_CONFIRM"/>
                </effect>
            </case>
            <case>
                <!-- The user communicated some intemidiate stops -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" relation="in" value="[ASK_STOPS,ASK_STOPS_MORE]"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <or>
                        <if var="NewInformation" relation="contains" value="Address(*)"/>
                        <if var="NewInformation" relation="contains" value="City(*)"/>
                    </or>
                </condition>
                <effect>
                    <set var="StopsKnown" value="true"/>
                    <set var="Stops" value="{NewInformation}"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="FINAL_CONFIRM"/>
                </effect>
            </case>
            <case>
                <!-- If theuser said that s/he knowns intermidiate stops but didn't communicate them, ask -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_STOPS"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Address(*)"/>
                    <if var="NewInformation" relation="!contains" value="City(*)"/>
                </condition>
                <effect>
                    <set var="StopsKnown" value="true"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_STOPS_MORE"/>
                </effect>
            </case>
            <case>
                <!-- The user didn't respond in any meaningful way -->
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="ASK_STOPS"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Answer(false)"/>
                    <if var="NewInformation" relation="!contains" value="Address(*)"/>
                    <if var="NewInformation" relation="!contains" value="City(*)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_STOPS"/>
                </effect>
            </case>
        </rule>
    </model>

    <model id="RequestProcessing" trigger="NewInformation">
        <rule>
            <case>
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="FINAL_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(true)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="current_step" value="REQUEST_PROCESSING"/>
                    <set var="a_m" value="SEND_REQUEST"/>
                </effect>
            </case>

            <case>
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="FINAL_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <!-- Reset -->
                    <set var="StartSlot" value="Missing"/>
                    <set var="StartCity" value="Missing"/>
                    <set var="MaybeStartCity" value="Missing"/>
                    <set var="StartSlotToBeDefined" value="false"/>
                    <set var="StartDate" value="Missing"/>
                    <set var="StartTime" value="Missing"/>
                    <set var="EndSlot" value="Missing"/>
                    <set var="EndCity" value="Missing"/>
                    <set var="EndTimeKnown" value="Missing"/>
                    <set var="EndDate" value="Missing"/>
                    <set var="EndTime" value="Missing"/>
                    <set var="VehicleType" value="Missing"/>
                    <set var="StopsKnown" value="Missing"/>
                    <set var="Stops" value="Missing"/>

                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="ASK_START_SLOT"/>
                </effect>
            </case>

            <case>
                <condition>
                    <if var="current_step" value="INFORMATION_RETRIEVAL"/>
                    <if var="a_m" value="FINAL_CONFIRM"/>
                    <if var="NewInformation" relation="contains" value="UU"/>

                    <if var="NewInformation" relation="!contains" value="Answer(true)"/>
                    <if var="NewInformation" relation="!contains" value="Answer(false)"/>
                </condition>
                <effect>
                    <set var="NewInformation" value="[]"/>
                    <set var="a_m" value="FINAL_CONFIRM"/>
                </effect>
            </case>
        </rule>
    </model>
</domain>
